# 派蒙头像查找算法

## 摘要

《原神》是使用Unity开发的游戏，基于UGUI的界面，会有自己的尺寸适配方案。根据尺寸适配，可以直接确定派蒙头像的位置，而不需要使用滑窗检测。确定派蒙头像位置后，使用预设的两个轻量化模板，就可以确定派蒙是否存在以及使用的是什么设备。

## 《原神》的尺寸适配方案

以小地图为例，简单来说可以分为以下几点：

* 根据预设的布局，地图始终会吸附到左上角，不会因为长宽比的变化而拉伸。
* 如果长宽比>16:9，即带鱼屏，则UI的高度固定，宽度拉伸，地图随着左边缘移动
* 如果长宽比<16:9，即老电脑/Pad等，则UI的宽度固定，高度拉伸，地图随着上边缘移动
* 分辨率相同的情况下，地图也会随着分辨率缩放，但其在界面百分比是不变的。
  * 如果有两个尺寸相同但是分辨率不同的屏幕，比如23寸1080p和23寸4k，则4k屏的地图分辨率是1080p的两倍，但视觉上尺寸是相同的

![UI的变换](https://user-images.githubusercontent.com/99392726/215996823-f1623293-b8c9-48e1-913f-48ad52603ec2.png)

因此，有一个非常简单的预处理方案：

* 如果长宽比>16:9，则高度固定为1080px，宽度等比缩放
* 如果长宽比<16:9，则宽度固定为1080px，高度等比缩放

经过上述处理后，以图像的左上角为原点，则不同宽高比的画面地图会完全重叠，这样就消除了屏幕尺寸对于定位的影响，可以直接使用固定的坐标来表示。

![处理后的图像](https://user-images.githubusercontent.com/99392726/215999661-9f6048c2-1760-4ae6-883d-4aaf19424f6c.png)


## 派蒙定位

基于上述的处理，很容易就可以得到派蒙头像的位置，以x,y,w,h的顺序可以定义一个包围框找出派蒙的头像

```cpp
// 键鼠操作
const cv::Rect MatchPaimonKeyPointRect =
{
	25,12,68,77
};

// 手柄操作
const cv::Rect MatchPaimonHandleKeyPointRect =
{
	89,42,57,64
};
```
根据包围框，可以提取出派蒙的头像，但因为键鼠和手柄的UI布局略有不同，所以还需要做二次判断

![裁剪方式工作于不同输入中](https://user-images.githubusercontent.com/99392726/216005183-beee562d-b4bb-446c-9b54-7cae6b2c68ed.png)

## 简单的模板匹配

然而，即使预先缩放了尺寸，但分辨率对画面的影响依然是比较大的

![你永远都不知道用户会用什么屏幕玩原神](https://user-images.githubusercontent.com/99392726/216009857-2a4311e2-56e3-4861-8833-55729f818eba.png)

为了保证识别效果稳定，且优化性能消耗，这里仅选择几个关键的像素作为模板，选择的点尽量处于大色块内。

![特征点](https://user-images.githubusercontent.com/99392726/216013683-1d294364-da3d-4268-a429-21d4c6c5a811.png)

然后做以下操作：

1. 根据模板，遮罩原图需要识别的区域
2. 计算各像素L2范数平均值（L2范数用来表示向量的欧氏距离，即衡量颜色的相似程度）

![运算结果，不匹配差异会很大](https://user-images.githubusercontent.com/99392726/216021436-95c8b7b4-1cc8-43eb-926c-9545191ead45.png)

由于选择的是大色块中的像素，所以缩放并不会对对应的颜色产生很大的干扰，因此，只需要准备键鼠和手柄的布局，就能识别派蒙是否存在以及当前使用的输入设备

## 硬编码

因为模板的像素点极少，所以其实可以写在代码中，这样就不需要对模版读写

目前代码中的像素如下，格式{{x,y},{B,G,R}}

```cpp
const std::vector<std::pair<cv::Point, cv::Vec3b>> MatchPaimonKeyPointList =
{
{{42,19},{143,196,233}},
{{17,23},{255,255,255}},
{{29,29},{101, 72, 41}},
{{52,41},{255,255,255}},
{{32,47},{255,255,255}},
{{19,51},{224,238,250}},
{{49,58},{255,255,255}},
{{24,70},{164,112, 70}},
};
const std::vector<std::pair<cv::Point, cv::Vec3b>> MatchPaimonHandleKeyPointList =
{
{{35,16},{143,196,233}},
{{16,19},{255,255,255}},
{{24,24},{101, 71, 42}},
{{38,28},{255,255,255}},
{{27,39},{255,255,255}},
{{16,42},{224,238,250}},
{{42,46},{255,255,255}},
{{20,57},{159,109, 67}},
};
```
